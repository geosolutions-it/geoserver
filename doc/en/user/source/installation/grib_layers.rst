.. _grib_layers:

Backup
------
#. Backup the GeoServer Datadir
#. Backup eventual DB tables being used as catalog for the GRIB Datasets (That  could be needed if ImageMosaic of GRIB have been configured, storing the mosaic index on DB)
#. Backup the index file automatically generated by GRIB/NetCDF library for the involved GRIB files (i.e. \*.gbx9, \*.ncx3; \*.ncx4)

Reconfigure the data
--------------------

Basic cleanup
~~~~~~~~~~~~~
If a GRIB layer of a certain store stopped working:

#. Remove the affected store, either Mosaic or GRIB Store, referring to the problematic GRIB files. 

   * Follow up standard procedure to delete affected stores and underlying layer
   * Alternatively, consider using `REST APIs <https://docs.geoserver.org/stable/en/api/#1.0.0/coveragestores.yaml/>`__ to do that by referring to the DELETE method for ``/workspaces/{workspace}/coveragestores/{store}`` . Use ``?recurse=true&purge=metadata`` to delete layers and auxiliary files as well

#. Remove any auxiliary/cache file associated with the underlying GRIB file (assuming the file is named gribfile.grib2):

   * gribfile.ncx3
   * gribfile.ncx4
   * gribfile.gbx9
   * .gribfile_hash folder (if not previously deleted) either located beside the original file, or within the configured `NETCDF_DATA_DIR <https://docs.geoserver.org/main/en/user/extensions/netcdf/netcdf.html#netcdf-files-in-read-only-directories>`__ (if defined).

   * The screenshot below, represents an actual example of a tpcprblty.2019100912.incremental.grib2 file with related auxiliary/cache files

    .. figure:: images/grib_auxiliary_files.png

Additional steps needed in case of ImageMosaic of GRIBs
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. Remove any automatically created ImageMosaic configuration file within the ImageMosaic root folder. Assuming the underlying ImageMosaic was named mosaicM, containing coverages related to VariableA, VariableB, VariableC, …:

   * VariableA.properties, VariableB.properties, VariableC.properties, …
   * VariableAsample_image.dat, VariableBsample_image.dat, VariableCsample_image.dat, …
   * mosaicM.xml

#. If using a datastore.properties connecting to an actual DB, cleanup the tables from the DB

   * Assuming that all the grib files belonging to the same ImageMosaic are affected by the same issue, you can delete the related tables and allow the imageMosaic reconfiguration to recreate them.
   * Based on the above example, the naming convention is that granules for VariableA are stored on table named VariableA and so on.

#. Recreate the indexer.xml and _auxiliary.xml file as reported in the `NetCDF documentation <https://docs.geoserver.org/main/en/user/extensions/netcdf/netcdf.html#setting-up-a-basic-mosaic>`__ . (At the end, GRIB file are served through the NetCDF libraries)

Post cleanup actions
--------------------
#. Recreate the stores and layers using the known procedures.